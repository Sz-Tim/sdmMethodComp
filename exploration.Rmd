---
title: "Exploration"
author: "Tim Szewczyk"
date: "2/16/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pkgs <- c("fields", "sevcheck", "gbPopMod", "IPMpack", "tidyverse", "magrittr")
suppressMessages(invisible(lapply(pkgs, library, character.only=TRUE)))
theme_set(theme_bw())
```

# Exploration of options for the simulation component

## Species description: Life history, characteristics, relevant attributes
The simulated species is fully described here. The object `sp_i` is a list containing three elements: one for each SDM approach. Each of these contains elements for the global parameters, relationships with environmental variables, and demographic matrices that are applicable or potentially applicable for that modeling strategy.
```{r sp_i}
set.seed(1)
n.cell <- 10
n_i <- rpois(10, 200)
sp_i <- list(c_i=list(),
             m1_i=list(),
             m2_i=list(p=list(s_b=c(-4, 1.3), # b1 + b2*size
                              s_x=c(-2, -2), # b1*temp + b2*temp^2
                              g_b=c(0.8, 1.5, -0.1), # b1 + b2*size + b3*size^2
                              g_sig2=c(0.01, 0.35), # N(E, s1*exp(2*s2*size))
                              fl_b=c(-6.5, 1.9, -.2, .1), # b1 + b2*size + b3*size^2 + b4*size^3
                              seed_b=c(2.9, 0.05), # b1 + b2*size
                              rcrt=c(1.5, 0.4), #N(mean=rcrt1, sd=rcrt2)
                              p_est=0.02)))
```


## Landscape
The landscape characteristics are aggregated here. It is a gridded landscape with climate and LULC data.
```{r landscape}
# lc.df <- read_csv("data/landcover_5km.csv") %>% 
#   filter(!is.na(nlcd1_mean) & !is.na(bio1_mean) & 
#            !is.na(rdLen) & !is.na(pop_sum)) %>%
#   select(-c(9:14))

# n.cell <- n.rows * n.cols
env.df <- tibble(
  # x=rep(1:n.cols, each=n.rows),
  #                y=rep(1:n.rows, times=n.cols),
  #                x_y=paste(x, y, sep="_"),
                 temp_mean=rnorm(n.cell),
                 temp_min=rnorm(n.cell),
                 temp_max=rnorm(n.cell),
                 prec_mean=rnorm(n.cell),
                 prec_min=rnorm(n.cell),
                 prec_max=rnorm(n.cell)) #%>%
  # full_join(.[,3:9], by="x_y", suffix=c("", "_sq")) %>%
  # mutate_at(10:15, function(x) x*x)
```


## Correlative: MaxEnt
```{r MaxEnt}

```


## Mechanistic: CA
```{r CA}

```


## Mechanistic: IPM
```{r IPM_onePop}
# Simulated based on Merow et al 2014 Appendix A
p <- sp_i$m2_i$p
d <- data.frame(size=runif(n=n_i[1], min=1, max=7))
n <- nrow(d)
lo <- min(d$size)*0.5
hi <- max(d$size)*1.5
size.mx <- cbind(1, d$size, d$size^2, d$size^3)

# survival
E_surv <- antilogit(size.mx[,1:length(p$s_b)] %*% p$s_b)
d$surv <- rbinom(n, 1, E_surv)
plot(d$size, E_surv, ylim=c(0,1)); points(d$surv~d$size, pch=19)

# growth
E_grow <- size.mx[,1:length(p$g_b)] %*% p$g_b
d$sizeNext <- rnorm(n, mean=E_grow, sd=p$g_sig2[1]*exp(2*p$g_sig2[2]*d$size))
d$sizeNext <- ifelse(d$surv, d$sizeNext, NA)
plot(d$size, E_grow, ylim=c(lo,hi)); points(d$sizeNext~d$size, pch=19)

# flowering 
E_fl <- antilogit(size.mx[,1:length(p$fl_b)] %*% p$fl_b)
d$fl <- rbinom(n, 1, E_fl) 
plot(d$size, E_fl, ylim=c(0,1)); points(d$fl~d$size, pch=19)

# seed production
E_seed <- exp(d$fl * size.mx[,1:length(p$seed_b)] %*% p$seed_b)
d$seed <- rpois(n, E_seed)
d$seed <- ifelse(d$fl, d$seed, 0)
d$fl <- ifelse(d$surv, d$fl, NA)
d$seed <- ifelse(d$surv, d$seed, NA)
seed.range <- range(d$seed, na.rm=TRUE)
plot(d$size, E_seed, ylim=seed.range); points(d$seed~d$size, pch=19, col=1+d$fl)

# recruits
rcrt.n <- sum(d$seed, na.rm=TRUE)*p$p_est
d[(n+1):(n+rcrt.n),] <- NA
d$sizeNext[(n+1):(n+rcrt.n)] <- rnorm(rcrt.n, p$rcrt[1], p$rcrt[2])
hist(d$sizeNext[(n+1):(n+rcrt.n)])
```

```{r IPM_multPop}
p <- sp_i$m2_i$p
d <- vector("list", length=n.cell)
for(i in 1:n.cell) {
  d[[i]] <- data.frame(size=runif(n=n_i[i], min=1, max=7))
  size.mx <- cbind(1, d[[i]]$size, d[[i]]$size^2, d[[i]]$size^3)
  
  # survival
  E_surv <- antilogit(size.mx[,1:length(p$s_b)] %*% p$s_b +
                        rep(as.matrix(env.df[i,1:length(p$s_x)]) %*% p$s_x, 
                            n_i[i]))
  d[[i]]$surv <- rbinom(n_i[i], 1, E_surv)
  plot(d[[i]]$size, E_surv, ylim=c(0,1)); points(surv~size, data=d[[i]], pch=19)
  
  # growth
  E_grow <- size.mx[,1:length(p$g_b)] %*% p$g_b
  d[[i]]$sizeNext <- rnorm(n_i[i], mean=E_grow, 
                           sd=p$g_sig2[1]*exp(2*p$g_sig2[2]*d[[i]]$size))
  d[[i]]$sizeNext <- ifelse(d[[i]]$surv, d[[i]]$sizeNext, NA)
  # plot(d[[i]]$size, E_grow, ylim=c(lo,hi))
  # points(d[[i]]$sizeNext~d[[i]]$size, pch=19)
  
  # flowering 
  E_fl <- antilogit(size.mx[,1:length(p$fl_b)] %*% p$fl_b)
  d[[i]]$fl <- rbinom(n_i[i], 1, E_fl) 
  # plot(d[[i]]$size, E_fl, ylim=c(0,1))
  # points(d[[i]]$fl~d[[i]]$size, pch=19)
  
  # seed production
  E_seed <- exp(d[[i]]$fl * size.mx[,1:length(p$seed_b)] %*% p$seed_b)
  d[[i]]$seed <- rpois(n_i[i], E_seed)
  d[[i]]$seed <- ifelse(d[[i]]$fl, d[[i]]$seed, 0)
  d[[i]]$fl <- ifelse(d[[i]]$surv, d[[i]]$fl, NA)
  d[[i]]$seed <- ifelse(d[[i]]$surv, d[[i]]$seed, NA)
  seed.range <- range(d[[i]]$seed, na.rm=TRUE)
  # plot(d[[i]]$size, E_seed, ylim=seed.range)
  # points(d[[i]]$seed~d[[i]]$size, pch=19, col=1+d[[i]]$fl)
  
  # recruits
  rcrt.n <- sum(d[[i]]$seed, na.rm=TRUE)*p$p_est
  rcrt.i <- (n_i[i]+1):(n_i[i]+rcrt.n)
  d[[i]][rcrt.i,] <- NA
  d[[i]]$sizeNext[rcrt.i] <- rnorm(rcrt.n, p$rcrt[1], p$rcrt[2])
  # hist(d[[i]]$sizeNext[rcrt.i])
}
```




